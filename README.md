# 股權分佈資料分析與視覺化系統

這是一個完整的台股股權分佈數據分析與視覺化系統，由三個獨立但功能銜接的程式組成。

## 專案概述

本專案旨在建立一個從資料獲取、處理到深度分析與繪圖的完整工作流：

1. **程式一**：從集保中心（TDCC）網站抓取歷史股權分佈數據
2. **程式二**：根據用戶輸入參數提取數據並疊加K線圖
3. **程式三**：進行深度分析並繪製多種分類的趨勢圖

## 安裝需求

### Python 環境
- Python 3.8 或以上版本

### 安裝依賴套件
```bash
pip install -r requirements.txt
```

### 額外需求
- Chrome 瀏覽器（用於網頁爬蟲）
- ChromeDriver（Selenium 會自動下載）

## 程式說明

### 程式一：股權分佈資料爬蟲 (`program1_data_scraper.py`)

**功能**：從 TDCC 網站抓取台股所有個股的股權分佈歷史資料

**使用方法**：
```bash
python program1_data_scraper.py
```

**特點**：
- 自動從 MoneyDJ 網站獲取股票代碼列表
- 排除 ETF、美債等非個股項目
- 支援首次執行（抓取過去一年資料）和增量更新
- 資料以股票代碼分資料夾儲存，每日一個 JSON/CSV 檔案

**輸出結構**：
```
stock_data/
├── 2330/
│   ├── 2024-08-26.json
│   ├── 2024-08-26.csv
│   └── ...
├── 2317/
│   └── ...
```

### 程式二：資料查詢與整理 (`program2_data_query.py`)

**功能**：根據使用者參數從本地資料庫提取數據並疊加K線圖

**使用方法**：

命令列模式：
```bash
python program2_data_query.py 2330 2024-01-01 2024-08-26
```

互動模式：
```bash
python program2_data_query.py
```

**參數說明**：
- `stock_code`：股票代號（4位數字）
- `start_date`：起始日期（YYYY-MM-DD）
- `end_date`：結束日期（YYYY-MM-DD）
- `--data-dir`：資料目錄路徑（可選）

**功能特點**：
- 自動尋找最接近指定日期的可用資料
- 解析股權分佈為三個表格：人數、股數、占比
- 從 Wearn.com 獲取K線資料
- 生成包含圖表的 Excel 檔案

**輸出**：
- Excel 檔案包含三個資料表和對應圖表
- 檔名格式：`{股票代號}_{起始日期}_to_{結束日期}_analysis.xlsx`

### 程式三：數據分析與繪圖 (`program3_data_analysis.py`)

**功能**：對程式二的輸出進行深度分析並繪製趨勢圖

**使用方法**：

命令列模式：
```bash
python program3_data_analysis.py input.xlsx --stock-price 500
```

互動模式：
```bash
python program3_data_analysis.py
```

**參數說明**：
- `excel_file`：程式二產生的 Excel 檔案路徑
- `--stock-price`：股價（用於金額定義分類）
- `--output-prefix`：輸出檔案前綴

**分析類型**：

1. **一般定義（股數）**：
   - 散戶：1-400,000 股
   - 中實戶：400,001-1,000,000 股
   - 大戶：1,000,001+ 股

2. **金額定義**（需提供股價）：
   - 散戶：< 500 萬
   - 小中實戶：500 萬-1,000 萬
   - 中實戶：1,000 萬-3,000 萬
   - 大戶：> 3,000 萬

3. **自定義級距**：
   - 支援使用者輸入任意持股級距組合

**輸出**：
- 三個 Excel 檔案（人數、股數、占比分析）
- 多種分類的趨勢圖（PNG 格式）
- 詳細的15級距趨勢圖

## 使用流程

### 完整使用流程：

1. **資料收集**：
   ```bash
   python program1_data_scraper.py
   ```

2. **資料查詢**：
   ```bash
   python program2_data_query.py 2330 2024-01-01 2024-08-26
   ```

3. **深度分析**：
   ```bash
   python program3_data_analysis.py 2330_2024-01-01_to_2024-08-26_analysis.xlsx --stock-price 500
   ```

### 注意事項：

1. **首次執行程式一**：
   - 需要較長時間抓取一年的歷史資料
   - 建議在網路狀況良好時執行
   - 如遇到網站限制，程式會自動重試

2. **程式二使用提醒**：
   - 確保程式一已執行並有相關股票資料
   - 如果指定日期無資料，程式會自動尋找最接近的日期
   - K線圖資料可能需要調整網站解析邏輯

3. **程式三分析選項**：
   - 金額定義分析需要提供準確的股價
   - 自定義級距可以靈活設定分析範圍
   - 生成的圖表支援中文顯示

## 故障排除

### 常見問題：

1. **Chrome/ChromeDriver 問題**：
   ```bash
   # 安裝 webdriver-manager 自動管理 ChromeDriver
   pip install webdriver-manager
   ```

2. **中文字體顯示問題**：
   - 程式已設定多種中文字體備選
   - 如有問題可手動安裝 Microsoft JhengHei 字體

3. **網路連線問題**：
   - 確保能正常訪問 TDCC 和相關網站
   - 如遇到反爬蟲限制，可調整爬取間隔時間

4. **記憶體不足**：
   - 大量資料處理時可能需要較多記憶體
   - 建議分批處理或增加虛擬記憶體

## 版本資訊

- 版本：v1.0
- 更新日期：2025-01-26
- 相容性：Python 3.8+

## 技術架構

```
資料來源 → 程式一 → 本地資料庫 → 程式二 → Excel檔案 → 程式三 → 分析圖表
   ↓         ↓          ↓          ↓        ↓         ↓         ↓
 TDCC    爬蟲程式   股票資料夾   查詢整理   表格圖表   深度分析   趨勢圖表
MoneyDJ              JSON/CSV              K線疊加              Excel
```

這個系統提供了完整的股權分佈分析工作流，從資料獲取到最終的視覺化分析，適合投資分析師、研究人員和對台股有興趣的使用者。