python


"""
文件資訊
專案名稱： 股權分佈資料分析與視覺化系統 (TDCC Data Analysis & Visualization System)
版本號： v1.0
撰寫日期： 2025-08-26
專案目的： 透過自動化流程，從公開網站獲取台股股權分佈數據，並根據多種維度進行客製化分析與視覺化。

專案總覽
本專案由三隻獨立但功能銜接的程式組成，旨在建立一個從資料獲取、處理到深度分析與繪圖的完整工作流。

程式一： 負責從集保中心（TDCC）網站抓取歷史股權分佈數據，建立一個本地資料庫。

程式二： 負責根據用戶輸入的參數，從本地資料庫中提取特定時間範圍的數據，並進行初步的表格整理與圖表疊加。

程式三： 負責讀取程式二的輸出，根據多種分類標準將數據分級並繪製成動態趨勢圖，最終輸出為 Excel 檔案。

系統架構圖
[程式 1: 資料抓取] (TDCC, MoneyDJ)
       |
       |  (輸出：股號資料夾，內含歷史資料文件)
       v
  [本地資料庫]
       |
       |  (輸入：股號, 起始日, 終點日)
       v
[程式 2: 查詢與整理] (Wearn.com)
       |
       |  (輸出：單一Excel檔案，含表格與圖表)
       v
[程式 3: 分析與繪圖]
       |
       |  (輸出：三張Excel圖表)
       v
 [最終報告]
程式一：股權分佈資料爬蟲
目的： 建立台股所有個股的股權分佈歷史資料庫。

輸入：

來源網站：https://www.tdcc.com.tw/portal/zh/smWeb/qryStock

台股股號參考來源：https://moneydj.emega.com.tw/js/StockTable.htm

核心邏輯：

資料獲取： 程式啟動時，讀取 MoneyDJ 網站上的所有台股股號。

排除清單： 依據股票名稱或類別，排除所有 ETF、美債等非「個股」股號。

首次執行：

從 TDCC 網站抓取所有符合條件的股號。

對每個股號，抓取該股號在網站上所能查詢到的過去一年所有日期的數據。

下載的資料應以日期排序（最舊到最新）。

後續執行：

檢查本地資料夾，對於已存在的股號資料夾，僅抓取新發布的日期資料，不重新下載已存在的日期。

輸出：

資料夾架構： 一個股號對應一個資料夾。

檔案格式： 每個資料夾內，以日期（例如 2024-08-26.json 或 2024-08-26.csv）命名檔案，內含當日股權分佈數據。

技術注意事項：

TDCC 網站為動態查詢頁面，需要處理表單提交（POST）或 JavaScript 載入的請求。無法使用簡單的 GET 請求。

程式需要能夠自動處理日期選擇的下拉式選單，並抓取當前頁面的資料。

需處理爬蟲過程中的錯誤、超時和重試機制。

程式二：資料查詢與整理
目的： 根據使用者指定的參數，從本地資料庫中提取數據，並疊加 K 線圖。

輸入：

使用者透過命令列或 GUI 介面輸入三個參數：

股號 (Stock Code)

起始日期 (Start Date)

結束日期 (End Date)

K 線圖來源：https://stock.wearn.com/cdata.asp?Year=112&month=04&kind=8069

核心邏輯：

日期比對： 對於使用者輸入的 起始日期 和 結束日期，在本地資料庫中尋找大於或等於該日期且最接近的週數數據。

異常處理： 如果在查詢時，大於該日期的資料還不存在，則回退到尋找小於該日期最接近的週數數據，並在輸出中附加 Warning 訊息。

數據整理：

將選定期間的數據，根據 TDCC 網站的持股分級，分別整理成三個獨立的表格：

表格 1： 人數。

表格 2： 股數/單位數。

表格 3： 占集保庫存數比例 ( % )。

圖表疊加：

從 Wearn.com 網站抓取該股號在同一期間的週 K 線圖與成交量數據。

將週 K 線圖與成交量圖，分別與上述三張表格疊加在同一張圖表上。將 K 線圖作為背景圖片疊加在圖表上

輸出：

格式： 一個 Excel 檔案，一個工作表中包含三個表格.

內容： 三個資料表格與三張對應的圖表，圖表應包含 K 線與成交量數據。

程式三：數據分析與繪圖
目的： 對程式二的輸出進行深度分析，並根據多種自定義標準繪製趨勢圖。

輸入：

程式來源： 程式二產出的 Excel 檔案。

使用者輸入（金額定義時需要）： 股價 (Stock Price)。

核心邏輯：

數據分級： 根據持股張數，將數據區分為 15 個級距，對應到三種不同的類別進行繪圖。

繪圖處理：

將三種指標（人數、股數、占比）各自繪製成獨立的趨勢曲線圖，總共三張圖。

每張圖中應包含 15 條線，每條線代表一個持股級距。

X 軸： 時間。

Y 軸：

圖一 Y 軸：人數。

圖二 Y 軸：股數/單位數。

圖三 Y 軸：占集保庫存數比例 ( % )。

刻度優化：

雙 Y 軸 (Dual Y-axis): 應預設為雙 Y 軸處理，以同時呈現兩種不同單位的數據。

動態刻度 (Dynamic Step Size): 程式需判斷曲線變化。如果一段區間（連續3個數據點的 Y 軸變動範圍在 Y 軸總範圍的 1% 時，自動調整刻度，則自動縮小 Y 軸刻度，以放大微小的變化，使趨勢更清晰可見。

三種分類繪圖：

類別一： 一般定義 (股數)

區間： 散戶 (1-400,000 股)，中實戶 (400,001-1,000,000 股)，大戶 (1,000,001+ 股)。

類別二： 金額定義 (金額 = 股數 x 股價)

區間： 散戶 (< 500 萬)，小中實戶 (500 萬-1,000 萬)，中實戶 (1,000 萬-3,000 萬)，大戶 (> 3,000 萬)。

類別三： 自由手動輸入

區間： 程式需支援使用者輸入任意的持股級距組合進行繪圖（例如：0-30，30-100 等）。

輸出：

格式： 三個獨立的 Excel 檔案，每個檔案包含一張圖表。  

內容： 三張分別代表「人數」、「股數」、「占比」的趨勢圖。


"""
